# Solidity 开发环境使用说明

## 环境概述

本项目已配置完整的 Solidity 开发环境，包括：
- **Node.js v24.6.0** - JavaScript 运行时
- **npm v11.5.1** - 包管理器
- **Hardhat v2.26.0** - 以太坊开发框架
- **Hardhat Toolbox** - 开发工具集合

## 项目结构

```
SolidityStudyNote/
├── contracts/              # 智能合约源码目录
│   └── HelloWorld.sol      # 示例智能合约
├── test/                   # 测试文件目录
│   └── HelloWorld.test.js  # 合约测试文件
├── scripts/                # 部署脚本目录
│   └── deploy.js          # 部署脚本
├── artifacts/              # 编译产物（自动生成）
├── cache/                  # 缓存文件（自动生成）
├── node_modules/           # 依赖包
├── hardhat.config.js       # Hardhat 配置文件
├── package.json            # 项目配置文件
└── README.md              # 项目说明
```

## 常用命令

### 基础命令

```bash
# 编译智能合约
npx hardhat compile

# 运行测试
npx hardhat test

# 清理编译缓存
npx hardhat clean

# 查看可用任务
npx hardhat help
```

### 网络相关命令

```bash
# 启动本地测试网络
npx hardhat node

# 在本地网络部署合约
npx hardhat run scripts/deploy.js --network localhost

# 在 Hardhat 内置网络部署（默认）
npx hardhat run scripts/deploy.js
```

### 控制台交互

```bash
# 启动 Hardhat 控制台
npx hardhat console

# 在控制台中可以执行以下操作：
# const HelloWorld = await ethers.getContractFactory("HelloWorld");
# const helloWorld = await HelloWorld.deploy("Hello, World!");
# await helloWorld.getMessage();
```

## 开发工作流

### 1. 编写智能合约

在 `contracts/` 目录下创建 `.sol` 文件：

```solidity
// contracts/MyContract.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

contract MyContract {
    // 合约代码
}
```

### 2. 编译合约

```bash
npx hardhat compile
```

编译成功后会在 `artifacts/` 目录生成编译产物。

### 3. 编写测试

在 `test/` 目录下创建测试文件：

```javascript
// test/MyContract.test.js
const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("MyContract", function () {
  it("Should work correctly", async function () {
    const MyContract = await ethers.getContractFactory("MyContract");
    const myContract = await MyContract.deploy();
    
    // 测试逻辑
    expect(await myContract.someFunction()).to.equal("expected value");
  });
});
```

### 4. 运行测试

```bash
npx hardhat test
```

### 5. 部署合约

创建部署脚本 `scripts/deploy.js`：

```javascript
const { ethers } = require("hardhat");

async function main() {
  const MyContract = await ethers.getContractFactory("MyContract");
  const myContract = await MyContract.deploy(/* 构造函数参数 */);
  
  await myContract.waitForDeployment();
  console.log("Contract deployed to:", await myContract.getAddress());
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
```

运行部署：

```bash
npx hardhat run scripts/deploy.js
```

## 网络配置

### 本地开发网络

1. **Hardhat 内置网络**（默认）
   - 自动启动和关闭
   - 每次运行测试时重置
   - 适合快速测试

2. **本地持久网络**
   ```bash
   # 启动本地网络（在单独终端运行）
   npx hardhat node
   
   # 在另一个终端部署到本地网络
   npx hardhat run scripts/deploy.js --network localhost
   ```

### 测试网络配置

要连接到测试网络（如 Sepolia），需要在 `hardhat.config.js` 中添加配置：

```javascript
require("@nomicfoundation/hardhat-toolbox");
require("dotenv").config();

module.exports = {
  solidity: "0.8.24",
  networks: {
    sepolia: {
      url: `https://sepolia.infura.io/v3/${process.env.INFURA_PROJECT_ID}`,
      accounts: [process.env.PRIVATE_KEY]
    }
  }
};
```

创建 `.env` 文件（不要提交到 git）：
```
INFURA_PROJECT_ID=your_infura_project_id
PRIVATE_KEY=your_private_key
```

## 调试技巧

### 1. 使用 console.log

在合约中添加调试输出：

```solidity
import "hardhat/console.sol";

contract MyContract {
    function myFunction(uint256 value) public {
        console.log("Value is:", value);
        // 合约逻辑
    }
}
```

### 2. 使用 Hardhat 网络分叉

```javascript
// hardhat.config.js
module.exports = {
  networks: {
    hardhat: {
      forking: {
        url: "https://mainnet.infura.io/v3/YOUR_INFURA_KEY",
        blockNumber: 18000000  // 可选：指定区块号
      }
    }
  }
};
```

### 3. Gas 报告

```bash
# 安装 gas 报告插件
npm install --save-dev hardhat-gas-reporter

# 在 hardhat.config.js 中启用
require("hardhat-gas-reporter");

module.exports = {
  gasReporter: {
    enabled: true,
    currency: 'USD',
  }
};
```

## 常见问题解决

### 1. 编译错误

```bash
# 清理缓存后重新编译
npx hardhat clean
npx hardhat compile
```

### 2. 测试失败

- 检查合约逻辑
- 确认测试用例的预期结果
- 使用 `console.log` 调试

### 3. 部署失败

- 检查网络配置
- 确认账户余额足够支付 gas
- 检查合约构造函数参数

### 4. 依赖问题

```bash
# 重新安装依赖
rm -rf node_modules package-lock.json
npm install
```

## 有用的 Hardhat 插件

```bash
# 代码覆盖率
npm install --save-dev solidity-coverage

# 合约大小检查
npm install --save-dev hardhat-contract-sizer

# 文档生成
npm install --save-dev hardhat-docgen

# 升级检查
npm install --save-dev @openzeppelin/hardhat-upgrades
```

## 安全最佳实践

1. **永远不要提交私钥到代码仓库**
2. **使用 `.env` 文件存储敏感信息**
3. **在主网部署前进行充分测试**
4. **使用多重签名钱包管理重要合约**
5. **定期更新依赖包**
6. **进行代码审计**

## 学习资源

- [Hardhat 官方文档](https://hardhat.org/docs)
- [Solidity 官方文档](https://docs.soliditylang.org/)
- [OpenZeppelin 合约库](https://openzeppelin.com/contracts/)
- [Ethers.js 文档](https://docs.ethers.io/)

## 下一步

1. 尝试修改 `HelloWorld.sol` 合约
2. 运行测试确保功能正常
3. 创建自己的智能合约
4. 学习更高级的 Solidity 特性
5. 探索 DeFi 协议开发

---

如有问题，请参考官方文档或在项目 Issues 中提问。